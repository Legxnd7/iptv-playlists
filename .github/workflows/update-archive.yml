name: Update IPTV Archive

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # alle 6 Stunden automatisch ausführen

jobs:
  update-archive:
    runs-on: self-hosted

    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: Erstelle Archiv-Ordner (falls nicht vorhanden)
        shell: powershell
        run: |
          $archivePath = "C:\Users\Oliver\Desktop\IPTV-Archiv\archive"
          if (-not (Test-Path $archivePath)) {
            New-Item -ItemType Directory -Path $archivePath | Out-Null
          }

      - name: Lade aktuelle Playlist herunter (Windows-kompatibel)
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm"
          $outputPath = "C:\Users\Oliver\Desktop\IPTV-Archiv\archive\playlist_$timestamp.m3u"
          Invoke-WebRequest "https://legxnd7.github.io/iptv-playlists/playlist.m3u" -OutFile $outputPath
          Write-Host "Gespeichert als $outputPath"

      - name: Alte Archive löschen (älter als 3 Tage)
        shell: powershell
        run: |
          $archivePath = "C:\Users\Oliver\Desktop\IPTV-Archiv\archive"
          Get-ChildItem $archivePath -File |
            Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-3) } |
            Remove-Item -Force -ErrorAction SilentlyContinue

      - name: Änderungen committen und pushen
        shell: powershell
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add "C:\Users\Oliver\Desktop\IPTV-Archiv\archive\"
          git commit -m "Auto-update IPTV archive $(Get-Date -Format 'yyyy-MM-dd HH:mm')" -m "Automatisch erzeugt durch GitHub Runner" || Write-Host "Keine Änderungen zum Commit"
          git push
